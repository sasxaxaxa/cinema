# Онлайн-кинотеатр

Проект для курсовой работы с Django REST Framework.

## Описание

Система управления онлайн-кинотеатром с полным REST API, административной панелью и продвинутыми функциями фильтрации и экспорта.

## Функциональность

### REST API
- Полный CRUD для всех сущностей
- Аутентификация по токенам
- Права доступа (администраторы/пользователи)
- Фильтрация и поиск

### Административная панель
- Управление кинотеатрами, залами, фильмами
- Управление пользователями и билетами
- Экспорт данных в Excel
- История изменений

### Фильтрация (5 вариантов)
1. **Фильтр по текущему аутентифицированному пользователю**
2. **Фильтр по именованным аргументам в URL**
3. **Фильтр по GET параметрам**
4. **DjangoFilterBackend** через filterset_class
5. **SearchFilter** для поиска по полям

### Валидация
- Уникальность названий кинотеатров
- Валидация телефонов и email
- Проверка цен (положительные, не более 100000)
- Валидация адресов (минимум 10 символов)
- Проверка рейтингов (1-10)

## Установка и запуск

### Локальный запуск

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Выполните миграции:
```bash
cd cinema
python manage.py makemigrations
python manage.py migrate
```

3. Создайте суперпользователя:
```bash
python manage.py createsuperuser
```

4. Создайте тестовые данные:
```bash
python manage.py create_sample_data
```

5. Запустите сервер:
```bash
python manage.py runserver
```

Или используйте скрипт:
```bash
./run.sh
```

Админ-панель: http://127.0.0.1:8000/admin/
API: http://127.0.0.1:8000/api/

### Запуск в Docker

```bash
docker-compose up --build
```

## API Endpoints

REST API доступен по адресу `/api/`:

* `/api/movies/` - Фильмы
* `/api/cinemas/` - Кинотеатры
* `/api/screenings/` - Сеансы
* `/api/tickets/` - Билеты (только свои)
* `/api/reviews/` - Отзывы
* `/api/genres/` - Жанры
* `/api/persons/` - Персоны
* `/api/user/profile/` - Профиль пользователя
* `/api/user/register/` - Регистрация

### Примеры использования API

#### Фильтрация фильмов по жанру:
```
GET /api/movies/?genre=боевик
```

#### Фильтрация сеансов по цене:
```
GET /api/screenings/?min_price=200&max_price=500
```

#### Фильтрация билетов по статусу:
```
GET /api/tickets/?status=paid
```

#### Поиск фильмов:
```
GET /api/movies/?search=дуна
```

#### Получение предстоящих сеансов:
```
GET /api/screenings/upcoming/
```

#### Получение топ-рейтинговых фильмов:
```
GET /api/movies/top_rated/
```

## Management команды

### Создание тестовых данных:
```bash
python manage.py create_sample_data
```

### Очистка старых билетов:
```bash
python manage.py cleanup_old_tickets --days=365
```

### Сухой запуск очистки:
```bash
python manage.py cleanup_old_tickets --days=365 --dry-run
```

## Фильтрация

Реализовано 5 вариантов фильтрации:

1. **Фильтр по текущему аутентифицированному пользователю** - автоматически в get_queryset
2. **Фильтр по именованным аргументам в URL** - например, `?owner_id=1`
3. **Фильтр по GET параметрам** - например, `?name=пицца&min_price=100`
4. **DjangoFilterBackend** - через filterset_class
5. **SearchFilter** - поиск по полям

## Валидация

Реализована валидация в serializers:

* Уникальность названия кинотеатра
* Валидация телефона (российский формат)
* Проверка цены (положительная, не более 100000)
* Проверка адреса (минимум 10 символов)
* Валидация рейтинга отзыва (1-10)
* Проверка уникальности места в зале

## Экспорт в Excel

Экспорт доступен в админ-панели для:

* **Фильмов** (только с ценой >= 100 рублей в сеансах)
* **Билетов** (только завершенные за последний месяц)

Кастомизированы методы:
* `get_export_queryset`
* `dehydrate_*` для форматирования полей

## Linter

Настроен flake8 в файле `.flake8`

Запуск:
```bash
flake8 cinema/
```

## Docker

Проект настроен для запуска в Docker:

* `Dockerfile` - образ приложения
* `docker-compose.yml` - оркестрация
* `.dockerignore` - исключения

## Технологии

- **Django 4.2** - веб-фреймворк
- **Django REST Framework** - API
- **Django Filters** - фильтрация
- **Django Import-Export** - экспорт данных
- **Django Simple History** - история изменений
- **Django Unfold** - улучшенная админка
- **SQLite** - база данных
- **Docker** - контейнеризация

## Структура проекта

```
cinema/
├── management/commands/     # Management команды
├── migrations/              # Миграции базы данных
├── admin.py                 # Админка
├── filters.py               # Фильтры для API
├── models.py                # Модели данных
├── permissions.py           # Права доступа
├── serializers.py           # Сериализаторы API
├── urls.py                  # URL маршруты
└── views.py                 # Представления API
```

## Автор

Проект создан для курсовой работы по Django.
